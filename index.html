<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gods Unsealed Matches</title>
    <link rel="stylesheet" href="styles.css">

</head>

<body>
    <h1>Gods Unsealed Matches</h1>
    <div id="match-list"></div>

    <script>

        // Function to fetch match data
        async function fetchMatchData() {
            try {
                const endTime = Math.floor(Date.now() / 1000); // Current time in seconds
                const startTime = endTime - 60 * 3; // time in seconds ago

                // Fetch match data
                const matchResponse = await fetch(`https://api.godsunchained.com/v0/match?&end_time=${startTime}-${endTime}&perPage=100`);
                const matchData = await matchResponse.json();

                matchData.records.sort((a, b) => b.end_time - a.end_time);

                //console.log(matchData.records.filter(match => match.game_mode === 7));

                displayMatchInfo(matchData.records.filter(match => match.game_mode === 7));
            } catch (error) {
                console.error('Error fetching match data:', error);
            }
        }

        // Function to fetch user info
        async function fetchUserInfo(userId) {
            try {
                // Fetch user info
                const userInfoResponse = await fetch(`https://api.godsunchained.com/v0/properties?user_id=${userId}`);

                const userInfo = await userInfoResponse.json();
                return userInfo.records[0];
            } catch (error) {
                console.error('Error fetching user info:', error);
                return null;
            }
        }

        // Function to fetch user rank
        async function fetchUserRank(userId) {
            try {
                // Fetch user rank
                const userRankResponse = await fetch(`https://api.godsunchained.com/v0/rank?user_id=${userId}`);

                const userRank = await userRankResponse.json();
                return userRank.records[0];
            } catch (error) {
                console.error('Error fetching user rank:', error);
                return null;
            }
        }

        // Function to display match information
        async function displayMatchInfo(matches) {
            const matchInfoDiv = document.getElementById('match-list');

            for (const match of matches) {
                const playerWonInfo = await fetchUserInfo(match.player_won);
                const playerLostInfo = await fetchUserInfo(match.player_lost);
                const playerWonRank = await fetchUserRank(match.player_won);
                const playerLostRank = await fetchUserRank(match.player_lost);

                const matchStartTime = new Date(match.start_time * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const matchEndTime = new Date(match.end_time * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });

                matchInfoDiv.innerHTML += `
                    <div>
                        <p>Winner: ${playerWonInfo.username} (Rank: ${playerWonRank.rank_level})
                        Loser: ${playerLostInfo.username} (Rank: ${playerLostRank.rank_level})
                        God and God Power: ${match.player_info[0].god} (${match.player_info[0].god_power}) vs ${match.player_info[1].god} (${match.player_info[1].god_power})</p>
                        <p>Start Time: ${matchStartTime}
                        End Time: ${matchEndTime}
                        Game Mode: ${match.game_mode === 7 ? 'Sealed' : 'Constructed'}
                        Duration: ${Math.floor((match.end_time - match.start_time) / 60)} minutes
                        Rounds: ${match.total_rounds}</p>
                        <hr>
                    </div>
                `;
            }
        }

        // Fetch and display match data on page load
        fetchMatchData();
    </script>
</body>

</html>
